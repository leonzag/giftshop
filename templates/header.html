<header class="bg-zinc-900 shadow-md">
    <div class="container flex mx-auto px-4 py-3 items-center justify-between">
        <div class="flex items-center space-x-4">
            <button id="hamburger" class="lg:hidden text-zinc-600 hover:text-cyan-600 focus:outline-none"
                aria-label="Открыть меню" aria-expanded="false" aria-controls="mobile-menu">
                <i class="fas fa-bars text-2xl"></i>
            </button>

            <a href="{% url 'shop:product_list' %}" class="text-2xl font-bold text-gray-300">MyShop</a>
        </div>

        <nav id="menu" class="hidden lg:flex space-x-6">
            <a href="{% url 'shop:product_list' %}" class="text-gray-300 hover:text-cyan-600 transition duration-300">
                Главная</a>
            <a href="#" class="text-gray-300 hover:text-cyan-600 transition duration-300">О нас</a>
            <a href="#" class="text-gray-300 hover:text-cyan-600 transition duration-300">Услуги</a>
            <a href="#" class="text-gray-300 hover:text-cyan-600 transition duration-300">Контакты</a>
        </nav>

        {# include "searchbar.html" #}

        <div class="space-x-4">
            {% if request.user.is_authenticated %}
                <form action="{% url "account:logout" %}" method="post" class="inline-block">
                    {% csrf_token %}
                    <div class="relative inline-flex items-center justify-between pl-2 bg-green-700 rounded">
                        <i class="fa-solid fa-user"></i>
                        <span class="text-white px-2">{{ request.user.username }}</span>
                        <button type="submit" class="bg-red-700 hover:bg-red-800 text-white text-sm font-bold px-4 py-2 rounded">
                            Выйти
                        </button>
                    </div>
                </form>
            {% else %}
                <form action="{% url "account:login" %}" method="post" class="inline-block">
                    {% csrf_token %}
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white text-sm font-bold px-4 py-2 rounded">
                        Войти
                    </button>
                </form>
            {% endif %}

            <a href="{% url 'cart:cart_detail' %}" class="relative inline-flex space-x-1 items-center px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded hover:bg-blue-700 transition">
                <i class="fa-solid fa-cart-shopping"></i>
                <span>Корзина</span>
                {% if cart and cart|length %}
                    <span class="absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
                        {{ cart|length }}
                    </span>
                {% endif %}
            </a>

        </div>

    </div>

    <div id="mobile-menu" class="lg:hidden hidden bg-zinc-900 border-t border-zinc-600" role="navigation">
        <nav class="mx-auto px-4 py-3 space-y-2">
            <a href="{% url 'shop:product_list' %}" class="block text-gray-300 hover:text-cyan-600 transition duration-300">
                Главная</a>
            <a href="#" class="block text-gray-300 hover:text-cyan-600 transition duration-300">О нас</a>
            <a href="#" class="block text-gray-300 hover:text-cyan-600 transition duration-300">Услуги</a>
            <a href="#" class="block text-gray-300 hover:text-cyan-600 transition duration-300">Контакты</a>
        </nav>
    </div>
</header>

<script>
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobile-menu');

    // Обновляем состояние aria-expanded
    hamburger.addEventListener('click', () => {
        const isHidden = mobileMenu.classList.toggle('hidden');
        hamburger.setAttribute('aria-expanded', !isHidden);

        // Если меню открылось, переносим фокус на первый элемент меню
        if (!isHidden) {
            const firstMenuItem = mobileMenu.querySelector('a');
            if (firstMenuItem) {
                firstMenuItem.focus();
            }
        }
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', (event) => {
        if (!hamburger.contains(event.target) && !mobileMenu.contains(event.target)) {
            if (!mobileMenu.classList.contains('hidden')) { // Только если меню видимо
                mobileMenu.classList.add('hidden');
                hamburger.setAttribute('aria-expanded', 'false');
            }
        }
    });

    // Закрываем мобильное меню при изменении размера экрана на десктоп
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024 && !mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.add('hidden');
            hamburger.setAttribute('aria-expanded', 'false');
        }
    });

    // Улучшенная клавиатурная навигация (фокус-ловушка только для открытого мобильного меню)
    const trapFocus = (element) => {
        const focusableElementsSelector = 'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])';
        const focusable = Array.from(element.querySelectorAll(focusableElementsSelector));

        if (focusable.length === 0) return; // Нет фокусируемых элементов

        const firstFocusable = focusable[0];
        const lastFocusable = focusable[focusable.length - 1];

        element.addEventListener('keydown', (e) => {
            const isTabPressed = e.key === 'Tab' || e.keyCode === 9;

            if (!isTabPressed) {
                return;
            }

            if (e.shiftKey) { // Shift + Tab
                if (document.activeElement === firstFocusable) {
                    lastFocusable.focus();
                    e.preventDefault();
                }
            } else { // Tab
                if (document.activeElement === lastFocusable) {
                    firstFocusable.focus();
                    e.preventDefault();
                }
            }
        });
    };

    // Применяем trapFocus, когда мобильное меню открыто
    // и удаляем его, когда закрыто.
    // Вместо постоянного trapFocus на всем документе,
    // применяем его только к активному интерактивному компоненту.

    // Для простоты, здесь будет постоянный слушатель на mobileMenu,
    // но в более сложных приложениях это должно быть более динамично.
    trapFocus(mobileMenu);

    // Дополнительное улучшение: если мобильное меню закрывается, фокус возвращается на гамбургер
    mobileMenu.addEventListener('transitionend', () => {
        if (mobileMenu.classList.contains('hidden') && document.activeElement !== hamburger) {
            hamburger.focus();
        }
    });

</script>

<style>
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
</style>
